---
description: UI host/selector/FSM/HTMX behavior contracts.
paths:
  - apps/ui/src/**
  - apps/ui/test/**
---

# UI Rules

- Plane IDs are frozen API: `#conversation-plane,#execution-plane,#artifact-plane`.
- `#conv,#exec,#artifacts` are additive wrappers only.
- FSM contract is strict: `#run-status[data-state]` in `idle|running|done|error`; unknown backend status => `error`.
- Host boundary is strict: API host serves JSON truth; UI host serves HTML shell/fragments.
- UI non-HX and HX-history-restore must render full shell.
- Poll contract is single endpoint `/ui/runs/:id/poll` with atomic OOB updates for `#exec,#artifacts,#run-status`.
- `/ui/commands` must seed UI state from accepted `/runs` start payload before projection read (avoid accepted-start->idle race).
- Resume UI control appears only for `CANCELLED|RETRIES_EXCEEDED`; other statuses fail closed.
- UI route errors must preserve typed/opaque parity; never leak internal error strings; invalid/not-found runs must not render idle masks.
- Startup mode is explicit: embedded API default; split mode requires `UI_EMBED_API=0` and external API health.
- E2E asserts contracts/selectors/states/protocol, not pixel snapshots.

# Failure Recipes

- Selector/FSM break: restore frozen IDs/states or ship explicit additive migration + tests.
- Back/forward glitch: check HX full-vs-fragment branch and history-restore handling.
- Poll stuck/masked: verify error-state projection and OOB status updates.
