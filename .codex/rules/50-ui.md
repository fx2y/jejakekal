---
description: UI host/selector/FSM/HTMX/proxy behavior contracts.
paths:
  - apps/ui/src/**
  - apps/ui/test/**
---

# UI Rules

- Plane IDs are frozen product API: `#conversation-plane,#execution-plane,#artifact-plane`.
- `#conv,#exec,#artifacts` are additive wrappers only.
- FSM contract is strict: `#run-status[data-state]` in `idle|running|done|error`; unknown backend status => terminal `error`.
- Host split is strict: API host serves JSON truth; UI host serves HTML shell/fragments.
- UI non-HX and HX-history-restore requests must render full shell.
- Poll contract is single truth endpoint `/ui/runs/:id/poll` with atomic OOB updates for `#exec,#artifacts,#run-status`.
- `/ui/commands` must seed UI state from accepted `/runs` payload before projection read (avoid accepted-start -> idle race).
- Resume control appears only for `CANCELLED|RETRIES_EXCEEDED`; all other statuses fail closed.
- UI route errors preserve typed/opaque parity and host split: UI top-level opaque errors render HTML; JSON `internal_error` only for proxied API paths.
- Invalid/not-found UI run routes must not mask as idle.
- UI proxy for `/artifacts*` / bundle/download is byte-safe and preserves `content-type` + `content-disposition`.
- Startup mode is explicit: embedded API default; split mode requires `UI_EMBED_API=0` + healthy external API; avoid double-binding same `API_PORT`.
- E2E asserts selectors/FSM/protocol/contracts, not pixels.

# Failure Recipes

- Selector/FSM break: restore frozen IDs/states or ship explicit additive migration + tests.
- Back/forward glitch: audit full-shell vs fragment branch and HX history-restore path.
- Poll stuck/masked: inspect error-state projection + OOB status updates.
- Wrong media/error shape: verify UI-vs-API host routing boundary first.
