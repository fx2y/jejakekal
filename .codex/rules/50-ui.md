---
description: UI host/selector/FSM/HTMX/proxy behavior contracts.
paths:
  - apps/ui/src/**
  - apps/ui/test/**
---

# UI Rules

- Frozen plane IDs: `#conversation-plane,#execution-plane,#artifact-plane`; `#conv,#exec,#artifacts` are wrappers only.
- FSM is strict: `#run-status[data-state]` in `idle|running|done|error`; unknown backend status => terminal `error`.
- Host split is hard: API host returns JSON truth, UI host returns HTML shell/fragments.
- UI non-HX and HX-history-restore requests must render full shell.
- Poll truth endpoint is fixed: `/ui/runs/:id/poll`; one response carries atomic OOB updates for `#exec,#artifacts,#run-status`.
- `/ui/commands` seeds optimistic UI state from accepted `/runs` payload before projection read (prevents accepted-start -> idle race).
- Resume control is fail-closed: visible/allowed only for `CANCELLED|RETRIES_EXCEEDED`.
- UI route errors preserve host split: top-level opaque UI errors render HTML; JSON `internal_error` only on proxied API paths.
- Invalid/not-found run routes must not masquerade as idle.
- UI proxy for `/artifacts*` + bundle/download must be byte-safe and preserve `content-type`/`content-disposition`.
- Startup mode explicit: embedded API default; split mode requires `UI_EMBED_API=0` + healthy external API; no `API_PORT` double-bind.
- OCR telemetry on execution rows is additive text only (`hard_pages`,`gate_reason_count`,`ocr_pages`,`ocr_failures`,`ocr_model`); no new selector/route contracts.
- E2E asserts contracts/protocol, not pixel snapshots.

# Failure Recipes

- Selector/FSM break: restore frozen IDs/states or ship explicit additive migration + tests.
- Back/forward glitch: audit full-shell vs fragment branch and HX-history-restore path.
- Poll stuck/masked: inspect projection error mapping + OOB status updates.
- Wrong media/error shape: verify UI-vs-API host boundary first.
