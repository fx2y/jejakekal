#!/usr/bin/env bash
set -euo pipefail
docker compose -f infra/compose/docker-compose.yml up -d
for _ in $(seq 1 60); do
  if docker compose -f infra/compose/docker-compose.yml ps --format json \
    | jq -s -e 'length > 0 and all(.[]; .State == "running" and (.Health == "" or .Health == "healthy"))' >/dev/null 2>&1; then
    exit 0
  fi
  sleep 1
done
echo "stack did not become healthy in time" >&2
exit 1
